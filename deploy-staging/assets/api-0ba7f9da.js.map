{"version":3,"file":"api-0ba7f9da.js","sources":["../../src/services/api.js"],"sourcesContent":["// API Service for eBay Price Reducer\n// Connects frontend to Netlify Functions backend\n\nimport { logger } from '../utils/logger';\nimport { supabase } from '../lib/supabase';\n\nconst API_BASE_URL = import.meta.env.VITE_API_BASE_URL || '/.netlify/functions';\n\nclass ApiService {\n  constructor() {\n    this.baseURL = API_BASE_URL;\n  }\n\n  // Get authentication token from Supabase\n  async getAuthToken() {\n    const { data: { session } } = await supabase.auth.getSession();\n    return session?.access_token || null;\n  }\n\n  // Helper method for making requests with retry logic\n  async request(endpoint, options = {}, retries = 3) {\n    const url = `${this.baseURL}${endpoint}`;\n    let lastError;\n\n    // Get auth token\n    const token = await this.getAuthToken();\n\n    for (let attempt = 0; attempt <= retries; attempt++) {\n      try {\n        const config = {\n          headers: {\n            'Content-Type': 'application/json',\n            ...(token ? { 'Authorization': `Bearer ${token}` } : {}),\n            ...options.headers,\n          },\n          ...options,\n        };\n\n        const response = await fetch(url, config);\n        const data = await response.json();\n\n        if (!response.ok) {\n          // Don't retry client errors (4xx)\n          if (response.status >= 400 && response.status < 500) {\n            throw new Error(data.error || `HTTP error! status: ${response.status}`);\n          }\n\n          // Retry server errors (5xx) and network errors\n          if (attempt < retries) {\n            const delay = Math.min(1000 * Math.pow(2, attempt), 10000);\n            await new Promise(resolve => setTimeout(resolve, delay));\n            continue;\n          }\n\n          throw new Error(data.error || `HTTP error! status: ${response.status}`);\n        }\n\n        return data;\n      } catch (error) {\n        lastError = error;\n\n        // Don't retry on abort or client errors\n        if (error.name === 'AbortError' || error.message.includes('HTTP error!')) {\n          throw error;\n        }\n\n        // Retry network errors\n        if (attempt < retries) {\n          const delay = Math.min(1000 * Math.pow(2, attempt), 10000);\n          logger.warn(`API request failed, retrying in ${delay}ms...`, error);\n          await new Promise(resolve => setTimeout(resolve, delay));\n          continue;\n        }\n      }\n    }\n\n    logger.error(`API Error for ${endpoint} after ${retries} retries:`, lastError);\n    throw lastError;\n  }\n\n  // Generic HTTP methods\n  async get(endpoint, options = {}) {\n    return this.request(endpoint, {\n      method: 'GET',\n      ...options\n    });\n  }\n\n  async post(endpoint, data = null, options = {}) {\n    return this.request(endpoint, {\n      method: 'POST',\n      body: data ? JSON.stringify(data) : undefined,\n      ...options\n    });\n  }\n\n  async put(endpoint, data = null, options = {}) {\n    return this.request(endpoint, {\n      method: 'PUT',\n      body: data ? JSON.stringify(data) : undefined,\n      ...options\n    });\n  }\n\n  async delete(endpoint, options = {}) {\n    return this.request(endpoint, {\n      method: 'DELETE',\n      ...options\n    });\n  }\n\n  // Removed unused methods that called deleted backend functions:\n  // - testEbayConnection, getEbayListings, syncListings\n  // - togglePriceReduction, updateListingStrategy, updateItemPrice\n  // - runPriceReduction, manualPriceReduction\n\n  async getPriceChanges(days = 30, limit = 50) {\n    return this.request(`/get-price-changes?days=${days}&limit=${limit}`, {\n      method: 'GET'\n    });\n  }\n\n  async getPriceReductionLogs(days = 10, limit = 100, type = null) {\n    const typeParam = type ? `&type=${type}` : '';\n    return this.request(`/get-price-reduction-logs?days=${days}&limit=${limit}${typeParam}`, {\n      method: 'GET'\n    });\n  }\n\n  // Removed: analyzeMarket method (backend function deleted)\n\n  // Notifications\n  async sendNotification(userId, type, title, message, data = {}) {\n    return this.request('/notification-service', {\n      method: 'POST',\n      body: JSON.stringify({ userId, type, title, message, data })\n    });\n  }\n\n  // Removed unused methods that called deleted backend functions:\n  // - runScheduledJob, importListings, reducePrice, monitorScheduledReductions\n  // - getEbayAuthUrl, getEbayConnectionStatus, disconnectEbayAccount\n\n  // ASIN Correlation Analysis (n8n integration)\n\n  // Check if ASIN exists in database\n  async checkAsinCorrelation(asin) {\n    return this.request('/trigger-asin-correlation-v2', {\n      method: 'POST',\n      body: JSON.stringify({ asin, action: 'check' })\n    });\n  }\n\n  // Sync ASIN - processes via serverless function (all logic in-app, no external n8n)\n  async syncAsinCorrelation(asin) {\n    return this.request('/trigger-asin-correlation-v2', {\n      method: 'POST',\n      body: JSON.stringify({ asin, action: 'sync' })\n    });\n  }\n\n  // Legacy method for backwards compatibility\n  async triggerAsinCorrelation(asin) {\n    return this.checkAsinCorrelation(asin);\n  }\n\n  // ==================== BACKGROUND JOB API ====================\n  // For processing large batches (50+ variations) without timeout\n\n  // Start background correlation job (returns immediately, processes in background)\n  async startCorrelationJob(asin) {\n    return this.request('/asin-correlation-job', {\n      method: 'POST',\n      body: JSON.stringify({ action: 'start', asin })\n    });\n  }\n\n  // Check status of a correlation job\n  async getCorrelationJobStatus(jobId) {\n    return this.request(`/asin-correlation-job?action=status&jobId=${jobId}`, {\n      method: 'GET'\n    });\n  }\n\n  // List recent correlation jobs\n  async listCorrelationJobs(limit = 10) {\n    return this.request(`/asin-correlation-job?action=list&limit=${limit}`, {\n      method: 'GET'\n    });\n  }\n\n  // Poll job until complete (with timeout)\n  async waitForCorrelationJob(jobId, { \n    pollIntervalMs = 2000, \n    timeoutMs = 300000, // 5 minutes default\n    onProgress = null \n  } = {}) {\n    const startTime = Date.now();\n    \n    while (Date.now() - startTime < timeoutMs) {\n      const result = await this.getCorrelationJobStatus(jobId);\n      \n      // Call progress callback if provided\n      if (onProgress && result.job) {\n        onProgress(result.job);\n      }\n      \n      // Check if complete\n      if (result.isComplete) {\n        return result;\n      }\n      \n      // Wait before next poll\n      await new Promise(resolve => setTimeout(resolve, pollIntervalMs));\n    }\n    \n    throw new Error('Job timed out');\n  }\n\n  // Convenience method: start job and wait for completion\n  async syncAsinCorrelationBackground(asin, options = {}) {\n    // Start the job\n    const startResult = await this.startCorrelationJob(asin);\n    \n    if (!startResult.success) {\n      throw new Error(startResult.error || 'Failed to start job');\n    }\n    \n    // If already running, just poll that job\n    const jobId = startResult.jobId;\n    \n    // Wait for completion\n    return this.waitForCorrelationJob(jobId, options);\n  }\n}\n\n// Create and export a singleton instance\nconst apiService = new ApiService();\n\n// Export individual methods for easier importing\nexport const {\n  get,\n  post,\n  put,\n  delete: deleteMethod,\n  getPriceChanges,\n  getPriceReductionLogs,\n  sendNotification,\n  checkAsinCorrelation,\n  syncAsinCorrelation,\n  triggerAsinCorrelation,\n  // Background job methods\n  startCorrelationJob,\n  getCorrelationJobStatus,\n  listCorrelationJobs,\n  waitForCorrelationJob,\n  syncAsinCorrelationBackground\n} = apiService;\n\n// Export the full service as default\nexport default apiService;\n\n// Helper function to handle API errors consistently\nexport const handleApiError = (error, defaultMessage = 'An error occurred') => {\n  logger.error('API Error:', error);\n\n  if (error.message) {\n    return error.message;\n  }\n\n  return defaultMessage;\n};\n\n// Helper function to check if we're in demo mode\nexport const isDemoMode = () => {\n  return import.meta.env.VITE_DEMO_MODE === 'true';\n};\n"],"names":["API_BASE_URL","ApiService","session","supabase","endpoint","options","retries","url","lastError","token","attempt","config","response","data","delay","resolve","error","days","limit","type","typeParam","userId","title","message","asin","jobId","pollIntervalMs","timeoutMs","onProgress","startTime","result","startResult","apiService","apiService$1","handleApiError","defaultMessage"],"mappings":"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"}